---
phase: 02-content-data-layer
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - data/research.json
  - scripts/validate-content.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "Research JSON contains topics with descriptions"
    - "Research topics reference related publications by ID"
    - "Validation script validates all content against schemas"
    - "npm run validate succeeds with all content files"
  artifacts:
    - path: "data/research.json"
      provides: "Research topics with publication references"
      min_lines: 20
    - path: "scripts/validate-content.js"
      provides: "Ajv validation script for all content"
      min_lines: 30
  key_links:
    - from: "data/research.json"
      to: "data/publications.json"
      via: "relatedPublications ID references"
      pattern: "relatedPublications.*\\[.*\\]"
    - from: "scripts/validate-content.js"
      to: "data/schemas/*.schema.json"
      via: "ajv.compile()"
      pattern: "ajv\\.compile"
---

<objective>
Create research.json with topics referencing publications, and a validation script that validates all content files against their schemas.

Purpose: Research topics tie together related publications for discovery. The validation script ensures all content is structurally correct before deployment.
Output: Research topics JSON file and npm run validate command.
</objective>

<execution_context>
@/home/sam/.claude/get-shit-done/workflows/execute-plan.md
@/home/sam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-content-data-layer/02-CONTEXT.md
@.planning/phases/02-content-data-layer/02-RESEARCH.md
@data/schemas/research.schema.json
@data/publications.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create research.json with topics and publication references</name>
  <files>data/research.json</files>
  <action>
Create data/research.json containing research topics that reference related publications.

**From PROJECT.md context:**
- AI-enabled evidence synthesis
- LLMs in conservation
- Horizon scanning
- Invasive species (PhD topic)

**Structure per topic (from schema):**
```json
{
  "id": "topic-slug",
  "name": "Topic Display Name",
  "description": "Detailed description of the research area...",
  "relatedPublications": ["pub-id-1", "pub-id-2"]
}
```

**Key decisions from CONTEXT.md:**
- Research topics reference their related publications (topics -> papers direction)
- Flat list of research topics, not hierarchical
- IDs in relatedPublications must match publication IDs in publications.json

**Requirements:**
1. Read publication IDs from data/publications.json
2. Create 4-6 research topics matching Sam's research areas
3. Link each topic to 2-4 related publications by ID
4. Descriptions should be substantive (2-4 sentences)

**Source:** Use existing content.json.js research array as base, update IDs to match new publications.json.
  </action>
  <verify>
```bash
node -e "
const r = require('./data/research.json');
const p = require('./data/publications.json');
const pubIds = p.publications.map(x => x.id);
const refIds = r.researchTopics.flatMap(x => x.relatedPublications || []);
const valid = refIds.every(id => pubIds.includes(id));
console.log('Topics:', r.researchTopics.length, 'Refs valid:', valid);
"
```
Should show: Topics: >= 4, Refs valid: true
  </verify>
  <done>
- research.json contains 4-6 research topics
- Each topic has id, name, description
- relatedPublications arrays contain valid publication IDs
- All referenced publication IDs exist in publications.json
  </done>
</task>

<task type="auto">
  <name>Task 2: Create validation script and npm command</name>
  <files>scripts/validate-content.js, package.json</files>
  <action>
Create scripts/validate-content.js that validates all content files against their schemas using Ajv.

**Script requirements:**
1. Import Ajv and ajv-formats
2. Compile all 5 schemas once at startup (not per-validation)
3. Validate each content file against its schema
4. Report validation errors with file and field details
5. Exit with code 1 if any validation fails, 0 if all pass
6. Copy errors immediately after validation (Ajv overwrites errors property)

**Structure:**
```javascript
import Ajv from 'ajv';
import addFormats from 'ajv-formats';
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __dirname = dirname(fileURLToPath(import.meta.url));
const dataDir = join(__dirname, '..', 'data');
const schemaDir = join(dataDir, 'schemas');

const ajv = new Ajv({ allErrors: true });
addFormats(ajv);

// Compile schemas once
const schemas = {
  publication: ajv.compile(JSON.parse(readFileSync(join(schemaDir, 'publication.schema.json')))),
  talk: ajv.compile(JSON.parse(readFileSync(join(schemaDir, 'talk.schema.json')))),
  media: ajv.compile(JSON.parse(readFileSync(join(schemaDir, 'media.schema.json')))),
  research: ajv.compile(JSON.parse(readFileSync(join(schemaDir, 'research.schema.json')))),
  about: ajv.compile(JSON.parse(readFileSync(join(schemaDir, 'about.schema.json'))))
};

// Validate each file
const files = {
  publication: 'publications.json',
  talk: 'talks.json',
  media: 'media.json',
  research: 'research.json',
  about: 'about.json'
};

let hasErrors = false;

for (const [schemaName, fileName] of Object.entries(files)) {
  const data = JSON.parse(readFileSync(join(dataDir, fileName)));
  const validate = schemas[schemaName];
  const valid = validate(data);

  if (!valid) {
    hasErrors = true;
    const errors = [...validate.errors]; // Copy immediately
    console.error(`\n${fileName} validation failed:`);
    errors.forEach(err => {
      console.error(`  - ${err.instancePath || '/'}: ${err.message}`);
    });
  } else {
    console.log(`âœ“ ${fileName} valid`);
  }
}

process.exit(hasErrors ? 1 : 0);
```

**Add npm script to package.json:**
Add to scripts section: "validate": "node scripts/validate-content.js"

**Note:** Script uses ES modules (import) since the project uses "type": "module" in package.json.
  </action>
  <verify>
```bash
npm run validate
```
Should output checkmarks for all 5 files and exit with code 0.
If any validation fails, fix the data file and re-run.
  </verify>
  <done>
- scripts/validate-content.js exists and runs without errors
- package.json has "validate" script
- npm run validate checks all 5 content files
- Validation passes for all content (exit code 0)
  </done>
</task>

</tasks>

<verification>
1. research.json parses as valid JSON
2. All relatedPublications IDs exist in publications.json
3. scripts/validate-content.js runs without syntax errors
4. npm run validate exits with code 0
5. Validation output shows checkmarks for all 5 files
</verification>

<success_criteria>
- data/research.json exists with 4+ topics
- Research topics correctly reference publication IDs
- scripts/validate-content.js validates all content
- npm run validate passes (exit code 0)
- All 5 content files validate against their schemas
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-data-layer/02-04-SUMMARY.md`
</output>
