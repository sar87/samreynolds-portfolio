---
phase: 06-interactions-content
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - js/game/buildings.js
  - js/game/engine.js
autonomous: true

must_haves:
  truths:
    - "Location indicator shows current building name in HUD"
    - "Location updates when entering/exiting buildings"
    - "First visit to building shows welcome message"
    - "Return visit shows 'Welcome back' message"
  artifacts:
    - path: "js/game/buildings.js"
      provides: "Visit tracking and welcome messages"
      contains: "visitedBuildings"
    - path: "js/game/engine.js"
      provides: "Location display updates"
      contains: "updateLocationDisplay"
  key_links:
    - from: "js/game/engine.js"
      to: "current-location DOM"
      via: "textContent update"
      pattern: "locationEl.*textContent"
---

<objective>
Enhance location HUD and add context-aware dialog that recognizes returning visitors.

Purpose: Players should always know where they are (INT-05), and the game should feel responsive to player behavior by acknowledging return visits (INT-06).

Output: Enhanced location display and visit tracking system with context-aware welcome messages.
</objective>

<execution_context>
@/home/sam/.claude/get-shit-done/workflows/execute-plan.md
@/home/sam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-interactions-content/06-RESEARCH.md

# Game code
@js/game/buildings.js
@js/game/engine.js
@js/game/world.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add visit tracking to Buildings.js</name>
  <files>js/game/buildings.js</files>
  <action>
Add visit tracking to track which buildings the player has entered this session.

Add to Buildings object properties:
```javascript
// Track visited buildings this session
visitedBuildings: {},
```

Add method to check/record visits:
```javascript
// Record a building visit, return true if first visit
recordVisit(buildingId) {
    const isFirstVisit = !this.visitedBuildings[buildingId];
    this.visitedBuildings[buildingId] = true;
    return isFirstVisit;
},

// Check if building was visited
hasVisited(buildingId) {
    return !!this.visitedBuildings[buildingId];
},
```

Update getWelcomeMessage() to be context-aware:
```javascript
getWelcomeMessage(buildingId, isFirstVisit = true) {
    const building = World.buildings[buildingId];
    const name = building?.name || 'this building';

    const firstVisitMessages = {
        pembroke: `Welcome to Pembroke College! This is Sam's office. Look around to learn about Sam's background and research interests.`,
        library: `Welcome to the University Library! Browse the extensive shelves to discover publications and research papers.`,
        lab: `Welcome to the Research Lab! Examine the equipment to learn about current conservation AI projects.`,
        station: `Welcome to the TV Station! Explore to find podcasts, interviews, and media appearances.`,
        theatre: `Welcome to the Lecture Theatre! Check out recordings of talks and presentations.`
    };

    const returnVisitMessages = {
        pembroke: `Welcome back to Pembroke College! Feel free to explore more of Sam's office.`,
        library: `Welcome back to the Library! There's always more to discover in the stacks.`,
        lab: `Welcome back to the Research Lab! The team is still hard at work.`,
        station: `Welcome back to the TV Station! New episodes recording soon.`,
        theatre: `Welcome back to the Lecture Theatre! Ready for another talk?`
    };

    if (isFirstVisit) {
        return firstVisitMessages[buildingId] || `Welcome to ${name}!`;
    } else {
        return returnVisitMessages[buildingId] || `Welcome back to ${name}!`;
    }
}
```

Note: The existing getWelcomeMessage() only has first visit messages. We're expanding it to support return visits.
  </action>
  <verify>
Run `grep -c "visitedBuildings\|recordVisit\|hasVisited" js/game/buildings.js` - should return 5+
Run `grep "Welcome back" js/game/buildings.js` - should show return visit messages
  </verify>
  <done>
Buildings.js has:
- visitedBuildings object to track visits
- recordVisit() method that returns true on first visit
- hasVisited() method to check visit status
- getWelcomeMessage() that returns different messages for first vs return visits
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire visit tracking into building entry</name>
  <files>js/game/engine.js</files>
  <action>
Update the enterBuilding() method in Engine.js to use visit tracking.

Modify enterBuilding():
```javascript
enterBuilding(buildingId) {
    const interior = World.enterBuilding(buildingId);
    if (interior) {
        // Track visit and check if first time
        const isFirstVisit = Buildings.recordVisit(buildingId);

        Player.teleport(interior.spawn.x, interior.spawn.y, 'up');
        this.updateLocationDisplay();

        // Show context-aware welcome message
        const welcomeMsg = Buildings.getWelcomeMessage(buildingId, isFirstVisit);
        Buildings.showDialog(interior.name, welcomeMsg);
    }
}
```

The key change is:
1. Call Buildings.recordVisit() before showing welcome
2. Pass isFirstVisit to getWelcomeMessage()
  </action>
  <verify>
Run `grep "recordVisit\|isFirstVisit" js/game/engine.js` - should show both used in enterBuilding
  </verify>
  <done>Engine.enterBuilding() uses visit tracking to show context-aware welcome messages</done>
</task>

<task type="auto">
  <name>Task 3: Enhance location display styling</name>
  <files>css/game.css</files>
  <action>
Enhance the location indicator styling for better visibility and add transition effects.

Update .location-indicator in css/game.css:

```css
.location-indicator {
    background: var(--pixel-dark, rgba(26, 26, 46, 0.95));
    border: 3px solid white;
    padding: var(--spacing-xs, 6px) var(--spacing-md, 16px);
    color: white;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    box-shadow: 3px 3px 0 var(--pixel-black, #000);
    transition: opacity 0.3s ease, transform 0.3s ease;
}

.location-indicator.updating {
    opacity: 0.7;
    transform: scale(0.98);
}
```

Also ensure the HUD positioning is good. Current game-hud is at bottom, but research suggested top-left is better for location. Check if existing positioning works or needs adjustment.

Looking at css/game.css, the .game-hud is positioned at top (lines 23-34). The location-indicator styling is already there but could use the transition enhancement.

Add the .updating class support and ensure smooth transitions.
  </action>
  <verify>
Run `grep -A5 "location-indicator" css/game.css` - should show transition and updating styles
  </verify>
  <done>Location indicator has smooth transition effects and updating state styling</done>
</task>

</tasks>

<verification>
1. Start game: `npm run dev`, press G
2. Location shows "Cambridge Campus" in HUD
3. Enter Library (first time) - see "Welcome to the University Library!" message
4. Exit Library, re-enter Library - see "Welcome back to the Library!" message
5. Enter Pembroke (first time) - see first-visit welcome message
6. Exit and re-enter Pembroke - see return-visit message
7. Location indicator updates smoothly when entering/exiting buildings
8. Verify all 5 buildings have both first-visit and return-visit messages
</verification>

<success_criteria>
- Location HUD shows "Cambridge Campus" when on campus
- Location HUD shows building name when inside building (e.g., "University Library")
- First entry to building shows welcome message specific to that building
- Return entry to same building shows "Welcome back" variant
- Visit tracking persists during game session (not across page reloads)
- Location transitions are smooth (not jarring)
</success_criteria>

<output>
After completion, create `.planning/phases/06-interactions-content/06-03-SUMMARY.md`
</output>
