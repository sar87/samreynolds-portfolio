---
phase: 06-interactions-content
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - js/game/engine.js
  - js/game/world.js
  - js/game/buildings.js
  - css/game.css
autonomous: true

must_haves:
  truths:
    - "Interaction prompt appears when player is near interactive object"
    - "Prompt shows 'Press ENTER' (or 'Tap' on mobile) to interact"
    - "Pressing ENTER triggers the interaction handler"
    - "Prompt disappears when player moves away"
  artifacts:
    - path: "js/game/engine.js"
      provides: "Proximity check in game loop"
      contains: "checkNearbyInteractions"
    - path: "js/game/world.js"
      provides: "Interaction point detection"
      contains: "checkNearbyInteractions"
    - path: "js/game/buildings.js"
      provides: "Prompt display and interaction handling"
      contains: "updatePrompt"
    - path: "css/game.css"
      provides: "Prompt styling"
      contains: ".interaction-prompt"
  key_links:
    - from: "js/game/engine.js"
      to: "World.checkNearbyInteractions"
      via: "function call in loop"
      pattern: "World\\.checkNearbyInteractions"
    - from: "js/game/engine.js"
      to: "Buildings.updatePrompt"
      via: "function call in loop"
      pattern: "Buildings\\.updatePrompt"
    - from: "js/game/buildings.js"
      to: "handleInteraction"
      via: "ENTER key event"
      pattern: "handleInteraction"
---

<objective>
Implement proximity-based interaction detection and prompt display system.

Purpose: Players need visual feedback when near interactive objects and a way to trigger interactions. This is the core interaction loop that connects player position to content display (INT-01).

Output: Proximity detection in game loop, interaction prompts, and ENTER key handling to trigger interactions.
</objective>

<execution_context>
@/home/sam/.claude/get-shit-done/workflows/execute-plan.md
@/home/sam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-interactions-content/06-RESEARCH.md

# Existing game code
@js/game/engine.js
@js/game/world.js
@js/game/buildings.js
@css/game.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add proximity detection to World.js</name>
  <files>js/game/world.js</files>
  <action>
Add checkNearbyInteractions() method to World object that detects when player is within 1 tile of an interactive object.

Add to World object:
```javascript
// Check for nearby interactions at player position
checkNearbyInteractions(playerX, playerY) {
    // Only check interactions for current map (interior or campus)
    const currentMap = this.getCurrentMap();
    const interactions = currentMap?.interactions || [];

    for (const interaction of interactions) {
        const dx = Math.abs(interaction.x - playerX);
        const dy = Math.abs(interaction.y - playerY);

        // Adjacent or same tile (1-tile proximity)
        if (dx <= 1 && dy <= 1) {
            return interaction;
        }
    }
    return null;
},

// Helper to get current map data
getCurrentMap() {
    if (this.currentLocation === 'campus') {
        return this.maps.campus;
    }
    return this.interiors[this.currentLocation];
}
```

Also ensure each interior map in World.interiors has an `interactions` array. Check existing interior definitions and add interaction points if missing:

For Library interior, add interactions array with publication interaction points (bookshelves).
For Lab interior, add research equipment interactions.
For Theatre interior, add podium interactions for talks.
For Station interior, add media equipment interactions.
For Pembroke interior, add about/bio interactions.

Example interaction point format:
```javascript
interactions: [
    { x: 5, y: 2, type: 'publications', name: 'Bookshelf', index: 0 },
    { x: 8, y: 2, type: 'publications', name: 'Research Section', index: 1 },
]
```

See 06-RESEARCH.md lines 429-454 for example structure.
  </action>
  <verify>
Run `grep -c "checkNearbyInteractions\|getCurrentMap" js/game/world.js` - should return 4+
Run `grep "interactions:" js/game/world.js` - should show interaction arrays in interiors
  </verify>
  <done>
World.js has:
- checkNearbyInteractions(playerX, playerY) method
- getCurrentMap() helper method
- Each interior has an interactions array with typed interaction points
  </done>
</task>

<task type="auto">
  <name>Task 2: Add prompt display and ENTER key handling to Buildings.js</name>
  <files>js/game/buildings.js</files>
  <action>
Add interaction prompt management to Buildings object.

Add properties:
```javascript
// Interaction prompt state
promptElement: null,
currentInteraction: null,
```

Add to init() method (or create init if not exists):
```javascript
// Create prompt element if it doesn't exist
this.promptElement = document.getElementById('interaction-prompt');
if (!this.promptElement) {
    this.promptElement = document.createElement('div');
    this.promptElement.id = 'interaction-prompt';
    this.promptElement.className = 'interaction-prompt hidden';
    document.getElementById('game-container')?.appendChild(this.promptElement);
}

// ENTER key handler for interactions
document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && this.currentInteraction && !this.dialogOpen && !this.panelOpen) {
        e.preventDefault();
        this.handleInteraction(this.currentInteraction);
    }
});
```

Add updatePrompt() method:
```javascript
// Update interaction prompt based on nearby interaction
updatePrompt(interaction, isMobile = false) {
    if (!this.promptElement) return;

    if (interaction) {
        this.currentInteraction = interaction;
        const actionText = isMobile ? 'Tap to interact' : 'Press ENTER to interact';
        const objectName = interaction.name || interaction.type;
        this.promptElement.innerHTML = `<span class="prompt-object">${objectName}</span><br><span class="prompt-action">${actionText}</span>`;
        this.promptElement.classList.remove('hidden');
    } else {
        this.currentInteraction = null;
        this.promptElement.classList.add('hidden');
    }
},

// Hide prompt
hidePrompt() {
    if (this.promptElement) {
        this.promptElement.classList.add('hidden');
    }
    this.currentInteraction = null;
}
```

Add handleInteraction() method (or update existing):
```javascript
// Handle interaction with object
handleInteraction(interaction) {
    if (!interaction) return;

    switch (interaction.type) {
        case 'publications':
            if (interaction.index === 0 || interaction.index === undefined) {
                this.showPublicationsPanel();
            } else {
                this.showPublicationContent(interaction.index);
            }
            break;
        case 'talks':
            this.showTalksPanel();
            break;
        case 'media':
            this.showMediaPanel();
            break;
        case 'research':
            this.showResearchPanel();
            break;
        case 'about':
            this.showAboutContent();
            break;
        case 'exit':
            Engine.exitBuilding();
            break;
        default:
            console.log('Unknown interaction type:', interaction.type);
    }

    // Hide prompt after interaction
    this.hidePrompt();
}
```

Note: showPublicationsPanel(), showTalksPanel(), etc. will be implemented in Plan 03 (content formatting). For now, these methods can show placeholder dialogs or console logs.
  </action>
  <verify>
Run `grep -c "updatePrompt\|handleInteraction\|currentInteraction" js/game/buildings.js` - should return 8+
Run `grep "Enter.*handleInteraction" js/game/buildings.js` - should show ENTER key handler
  </verify>
  <done>
Buildings.js has:
- updatePrompt(interaction, isMobile) method that shows/hides prompt
- hidePrompt() method
- handleInteraction(interaction) method that dispatches to content panels
- ENTER key event listener that triggers handleInteraction
- currentInteraction property tracking nearby interaction
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire proximity check into Engine game loop and add prompt CSS</name>
  <files>js/game/engine.js, css/game.css</files>
  <action>
**In js/game/engine.js:**

Add proximity check to the game loop. Find the loop() or update() method and add:

```javascript
// In the game loop, after Player.update(dt)
if (!Buildings.isDialogOpen() && !Buildings.isPanelOpen()) {
    const interaction = World.checkNearbyInteractions(Player.tileX, Player.tileY);
    Buildings.updatePrompt(interaction, this.isMobile);
} else {
    Buildings.hidePrompt();
}
```

This should be added in the update/loop section, after player position is updated but before render.

Also add mobile tap handler for interactions:
```javascript
// In touch/click handler section
// Add tap-to-interact for mobile
if (this.isMobile && Buildings.currentInteraction && !Buildings.isDialogOpen() && !Buildings.isPanelOpen()) {
    // Detect tap on game area (not on UI elements)
    // Trigger interaction
    Buildings.handleInteraction(Buildings.currentInteraction);
}
```

**In css/game.css:**

Add interaction prompt styles:

```css
/* Interaction prompt */
.interaction-prompt {
    position: absolute;
    bottom: 120px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(26, 26, 46, 0.95);
    color: #fff;
    padding: 12px 24px;
    border: 3px solid #87ceeb;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    text-align: center;
    pointer-events: none;
    z-index: 180;
    animation: prompt-pulse 2s ease-in-out infinite;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
}

.interaction-prompt.hidden {
    display: none;
}

.interaction-prompt .prompt-object {
    color: #87ceeb;
    font-weight: bold;
    font-size: 16px;
}

.interaction-prompt .prompt-action {
    color: #aaa;
    font-size: 12px;
}

@keyframes prompt-pulse {
    0%, 100% {
        opacity: 0.95;
        border-color: #87ceeb;
    }
    50% {
        opacity: 1;
        border-color: #add8e6;
    }
}
```
  </action>
  <verify>
Run `grep "checkNearbyInteractions" js/game/engine.js` - should show call in game loop
Run `grep -c "interaction-prompt" css/game.css` - should return 5+
  </verify>
  <done>
- Engine.js game loop checks proximity each frame and calls Buildings.updatePrompt()
- Engine.js has mobile tap handler for interactions
- css/game.css has .interaction-prompt styles with animation
  </done>
</task>

</tasks>

<verification>
1. Game loads and runs: `npm run dev`, press G
2. Enter Library building
3. Walk near a bookshelf - prompt should appear "Bookshelf - Press ENTER to interact"
4. Walk away - prompt should disappear
5. Walk back and press ENTER - should trigger interaction (may show placeholder until Plan 03)
6. On mobile: prompt shows "Tap to interact"
7. Prompt styling matches game theme (dark background, light blue border)
</verification>

<success_criteria>
- Proximity detection works within 1 tile of interactive objects
- Prompt appears/disappears based on player position
- ENTER key triggers handleInteraction() when prompt is visible
- Prompt styling is visible and matches game theme
- Movement still works when not near interactions
- Dialog/panel being open hides prompt and blocks new interactions
</success_criteria>

<output>
After completion, create `.planning/phases/06-interactions-content/06-02-SUMMARY.md`
</output>
