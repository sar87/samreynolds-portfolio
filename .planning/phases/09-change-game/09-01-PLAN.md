---
phase: 09-change-game
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/game/sprites.js
autonomous: true

must_haves:
  truths:
    - "Sprite sheets load asynchronously before game starts"
    - "Sprites.get() returns coordinate data for tile rendering"
    - "Sprites.getCharacterFrame() returns correct 16x32 character frame"
  artifacts:
    - path: "js/game/sprites.js"
      provides: "Sprite sheet loading and coordinate mapping"
      contains: "loadSpriteSheet"
  key_links:
    - from: "js/game/sprites.js"
      to: "Pokemon Sprites/*.png"
      via: "Image() async loading"
      pattern: "new Image.*onload"
---

<objective>
Replace programmatic sprite generation with Pokemon sprite sheet loading system.

Purpose: The current sprites.js generates 1200+ lines of programmatic pixel art. Pokemon sprites are pre-made professional pixel art that must be loaded from sprite sheets and rendered via Canvas drawImage() with coordinate mapping.

Output: A new sprites.js that:
1. Loads Pokemon sprite sheets asynchronously
2. Maps sprite names to (sx, sy, sw, sh) coordinates
3. Returns sprite data for rendering (not canvas elements)
</objective>

<execution_context>
@/home/sam/.claude/get-shit-done/workflows/execute-plan.md
@/home/sam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-change-game/09-RESEARCH.md

Key source files:
@js/game/sprites.js
@js/game/engine.js (renders sprites - must understand current API)

Sprite sheets available:
- Pokemon Sprites/Game Boy Advance - Pokemon FireRed _ LeafGreen - Maps (Towns, Buildings, Etc.) - Pallet Town.png (1032x376)
- Pokemon Sprites/Game Boy Advance - Pokemon FireRed _ LeafGreen - Trainers & Non-Playable Characters - Overworld NPCs.png (238x2967)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze sprite sheets and create coordinate maps</name>
  <files>js/game/sprites.js</files>
  <action>
Open both Pokemon sprite sheets in the image viewer to understand their layout:

1. **Pallet Town map sheet (1032x376):**
   - Left section: Pallet Town outdoor map
   - Middle: Player House interiors (1F, 2F)
   - Middle: Rival House interior
   - Right: Professor Oak's Lab interior

2. **NPC Overworld sheet (238x2967):**
   - Find "CHARACTERS" label section
   - First row under CHARACTERS = player sprite
   - 4 frames per direction (16x32 each)
   - Directions: down, left, right, up (top to bottom rows)

Create a new sprites.js that:
- Defines SPRITE_SHEETS object with paths to both sprite files
- Defines TILE_COORDS object mapping tile names to {sx, sy, sw, sh}
- Defines CHARACTER_COORDS for player animation frames

Start with ESSENTIAL tiles only (expand later):
- Outdoor: grass, path, flower, tree_trunk, tree_top, water
- Exterior: house_wall, house_roof, house_door, lab_wall, lab_roof, lab_door
- Interior: floor, wall, door, stairs, table, chair, bookshelf, computer, sofa, tv, plant, rug
- Character: player_down_0-3, player_left_0-3, player_right_0-3, player_up_0-3

IMPORTANT: Pokemon GBA uses 16x16 tiles, 16x32 characters. Map coordinates by examining the sprite sheets visually. The Pallet Town sheet has the map on the left ~224 pixels wide, then interiors to the right.
  </action>
  <verify>
Read the new sprites.js and verify:
- SPRITE_SHEETS paths are correct relative paths
- TILE_COORDS has at least 10 tile types defined
- CHARACTER_COORDS has 16 frames (4 directions x 4 frames)
  </verify>
  <done>Coordinate map created with essential tiles and character frames</done>
</task>

<task type="auto">
  <name>Task 2: Implement async sprite sheet loading</name>
  <files>js/game/sprites.js</files>
  <action>
Add the sprite loading system to sprites.js:

```javascript
const Sprites = {
    tileSize: 16,      // Pokemon GBA tile size
    charWidth: 16,     // Character sprite width
    charHeight: 32,    // Character sprite height (2x tile)
    scale: 3,          // Render scale (adjust if needed)

    sheets: {},        // Loaded Image objects
    loaded: false,

    // Coordinate maps (from Task 1)
    TILE_COORDS: { ... },
    CHARACTER_COORDS: { ... },

    async loadSpriteSheet(name, path) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                this.sheets[name] = img;
                resolve(img);
            };
            img.onerror = () => reject(new Error(`Failed to load: ${path}`));
            img.src = path;
        });
    },

    async init() {
        await Promise.all([
            this.loadSpriteSheet('town', 'Pokemon Sprites/Game Boy Advance - Pokemon FireRed _ LeafGreen - Maps (Towns, Buildings, Etc.) - Pallet Town.png'),
            this.loadSpriteSheet('npcs', 'Pokemon Sprites/Game Boy Advance - Pokemon FireRed _ LeafGreen - Trainers & Non-Playable Characters - Overworld NPCs.png')
        ]);
        this.loaded = true;
        console.log('Pokemon sprite sheets loaded');
        return Promise.resolve();
    },

    // Get tile sprite data for rendering
    get(name) {
        const coords = this.TILE_COORDS[name];
        if (!coords) return null;
        return {
            image: this.sheets.town,
            ...coords
        };
    },

    // Get character frame for animation
    getCharacterFrame(direction, frame) {
        const key = `player_${direction}_${frame % 4}`;
        const coords = this.CHARACTER_COORDS[key];
        if (!coords) return null;
        return {
            image: this.sheets.npcs,
            ...coords,
            sw: this.charWidth,
            sh: this.charHeight
        };
    }
};

window.Sprites = Sprites;
```

The API must remain compatible:
- Sprites.init() returns a Promise (current code expects this)
- Sprites.get(name) returns sprite data (current returns canvas element - renderer will need update)
- Sprites.getCharacterFrame(dir, frame) returns frame data

DO NOT include any of the old programmatic drawing code. Delete createCharacterSprites(), createTileSprites(), createBuildingSprites(), createInteriorSprites(), createUISprites(), and all the drawPixel/drawing helper functions.
  </action>
  <verify>
Run `npm run dev` and check browser console:
1. Should see "Pokemon sprite sheets loaded" message
2. No errors loading sprite sheets
3. Sprites.loaded should be true after init
  </verify>
  <done>Sprites.js loads both sprite sheets asynchronously and provides get()/getCharacterFrame() API</done>
</task>

<task type="auto">
  <name>Task 3: Update engine.js renderer to use new sprite format</name>
  <files>js/game/engine.js</files>
  <action>
The current engine.js uses ctx.drawImage(spriteCanvas, ...) where spriteCanvas is a canvas element returned by Sprites.get().

Update the tile rendering to use the new sprite data format {image, sx, sy, sw, sh}:

In the tile rendering loop, change from:
```javascript
const sprite = Sprites.get(spriteName);
ctx.drawImage(sprite, screenX, screenY, tileSize * scale, tileSize * scale);
```

To:
```javascript
const sprite = Sprites.get(spriteName);
if (sprite && sprite.image) {
    ctx.drawImage(
        sprite.image,           // Source image (sprite sheet)
        sprite.sx, sprite.sy,   // Source position
        sprite.sw, sprite.sh,   // Source size
        screenX, screenY,       // Destination position
        tileSize * scale,       // Destination width
        tileSize * scale        // Destination height
    );
}
```

Also update character rendering in renderPlayer() if it exists in engine.js:
```javascript
const frame = Sprites.getCharacterFrame(player.direction, player.animFrame);
if (frame && frame.image) {
    ctx.drawImage(
        frame.image,
        frame.sx, frame.sy,
        frame.sw, frame.sh,
        screenX,
        screenY - tileSize * scale,  // Offset up by 1 tile (character is 2 tiles tall)
        frame.sw * scale,
        frame.sh * scale
    );
}
```

Ensure ctx.imageSmoothingEnabled = false is set for crisp pixel rendering.
  </action>
  <verify>
Run `npm run dev`:
1. Game should start without JS errors
2. Console shows sprite sheets loaded
3. Rendering may look broken (tiles not found) - that's expected until World.js tile types are updated in Plan 02
  </verify>
  <done>Engine.js uses drawImage with source coordinates from sprite data</done>
</task>

</tasks>

<verification>
After all tasks:
1. sprites.js is completely rewritten (~150-200 lines vs old 1200 lines)
2. Both sprite sheet images load successfully
3. Engine uses drawImage with source coordinates
4. Game starts without JS errors (visual rendering may be broken until Plan 02)
5. No programmatic sprite generation code remains
</verification>

<success_criteria>
- Sprites.init() loads both Pokemon sprite sheets asynchronously
- Sprites.get(name) returns {image, sx, sy, sw, sh} for tiles
- Sprites.getCharacterFrame(dir, frame) returns frame data for 16x32 characters
- Engine.js renderer updated to use new sprite data format
- Old programmatic sprite code deleted
</success_criteria>

<output>
After completion, create `.planning/phases/09-change-game/09-01-SUMMARY.md`
</output>
