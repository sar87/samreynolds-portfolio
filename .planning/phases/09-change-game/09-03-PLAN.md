---
phase: 09-change-game
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - js/game/player.js
  - js/game/engine.js
autonomous: true

must_haves:
  truths:
    - "Player character renders as 16x32 sprite (twice tile height)"
    - "Player animates with 4-frame walk cycle in each direction"
    - "Player sprite bottom-center aligns with tile position"
    - "Character renders crisp with pixel-perfect scaling"
  artifacts:
    - path: "js/game/player.js"
      provides: "Player movement and animation state"
      contains: "animFrame"
    - path: "js/game/engine.js"
      provides: "Character rendering with 16x32 sprites"
      contains: "getCharacterFrame"
  key_links:
    - from: "js/game/engine.js"
      to: "js/game/sprites.js"
      via: "getCharacterFrame for player rendering"
      pattern: "Sprites\\.getCharacterFrame"
---

<objective>
Update player.js and engine.js to handle 16x32 Pokemon character sprites.

Purpose: Pokemon GBA characters are 16x32 pixels (16 wide, 32 tall) - twice the height of tiles. The current system assumes 16x16 characters. This causes positioning and clipping issues. The player must render with bottom-center alignment to their tile position.

Output:
1. Player.js handles correct sprite dimensions
2. Engine.js renders 16x32 character with proper offset
3. Walk animation cycles through 4 frames correctly
</objective>

<execution_context>
@/home/sam/.claude/get-shit-done/workflows/execute-plan.md
@/home/sam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-change-game/09-RESEARCH.md
@.planning/phases/09-change-game/09-01-SUMMARY.md

Key source files:
@js/game/player.js
@js/game/engine.js
@js/game/sprites.js (getCharacterFrame API)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update player.js for Pokemon sprite dimensions</name>
  <files>js/game/player.js</files>
  <action>
Update Player object to handle 16x32 character sprites:

1. **Add sprite dimension constants:**
```javascript
spriteWidth: 16,   // Character width in pixels
spriteHeight: 32,  // Character height in pixels (2x tile)
```

2. **Animation frame handling:**
The walk animation should cycle through frames 0-3 during movement.
Current frame counter logic is likely fine, but verify:
- Standing still = frame 0 (or idle frame)
- Walking = cycle frames 0,1,2,3 based on time/distance
- Frame changes every ~150ms or every ~8 pixels moved

3. **Position represents FOOT position:**
Player.pixelX and pixelY should represent where the player's feet are (bottom-center of sprite). The rendering will offset upward by spriteHeight - tileSize to draw correctly.

4. **Collision should use foot position:**
The collision detection should check the tile at the player's feet, not the entire sprite height. This is likely already correct if collision checks tile position.

Update any comments or documentation to clarify the 16x32 sprite handling.
  </action>
  <verify>
Read player.js:
- Has spriteWidth/spriteHeight constants (16x32)
- Animation frame cycles 0-3
- Comments indicate position is foot-based
  </verify>
  <done>Player.js updated with correct 16x32 sprite handling</done>
</task>

<task type="auto">
  <name>Task 2: Update engine.js player rendering</name>
  <files>js/game/engine.js</files>
  <action>
Update the player rendering in engine.js to:

1. **Get character frame from sprites.js:**
```javascript
const frame = Sprites.getCharacterFrame(Player.direction, Player.animFrame);
```

2. **Calculate screen position with offset:**
Since the character is 32px tall but only occupies 1 tile position, draw the sprite offset upward:

```javascript
// Player pixel position is at their feet (bottom-center of sprite)
// Screen position needs to offset up by (spriteHeight - tileSize) to draw correctly
const screenX = (Player.pixelX - this.camera.x) * this.scale;
const screenY = (Player.pixelY - this.camera.y) * this.scale;

// Offset Y by one tile worth (character is 2 tiles tall, foot at bottom)
const spriteScreenY = screenY - (Sprites.tileSize * this.scale);

if (frame && frame.image) {
    this.ctx.drawImage(
        frame.image,
        frame.sx, frame.sy,
        frame.sw, frame.sh,
        Math.floor(screenX),
        Math.floor(spriteScreenY),
        frame.sw * this.scale,
        frame.sh * this.scale
    );
}
```

3. **Ensure image smoothing is disabled:**
```javascript
this.ctx.imageSmoothingEnabled = false;
```
This should be set once during canvas setup, but verify it's present.

4. **Render order:**
The player should render AFTER ground/object tiles so they appear on top.
  </action>
  <verify>
Run `npm run dev`:
1. Player character visible on map
2. Character is visibly taller than tiles (2x height)
3. Character feet align with ground (not floating or sunken)
4. Moving shows animation (not static sprite)
5. Sprite is crisp, not blurry
  </verify>
  <done>Engine.js renders 16x32 player with correct offset and animation</done>
</task>

<task type="auto">
  <name>Task 3: Test and adjust scale factor</name>
  <files>js/game/sprites.js, js/game/engine.js</files>
  <action>
Test the game at different scale factors to find optimal rendering:

Current system uses scale=3 (16px tiles -> 48px rendered).
Pokemon sprites may look better at scale=2 (32px) or scale=4 (64px).

1. **Test at scale=3 (current):**
   - Run game, evaluate visual quality
   - Check if sprites look appropriately sized

2. **Test at scale=2:**
   - Change Sprites.scale = 2 (or engine scale if separate)
   - Evaluate - sprites may be too small on modern screens

3. **Test at scale=4:**
   - Change scale to 4
   - Evaluate - may be too large, but more faithful to original GBA feel on retina displays

**Decision criteria:**
- Player character should be clearly visible
- Map should fit reasonably on screen
- Pixels should be crisp and distinct
- Works on both desktop and mobile viewports

Set the final scale value in sprites.js (Sprites.scale).

ALSO: Ensure the canvas CSS has `image-rendering: pixelated` for crisp scaling:
```css
#game-canvas {
    image-rendering: pixelated;
    image-rendering: -moz-crisp-edges;
    image-rendering: crisp-edges;
}
```
Check if this exists in the CSS, add if missing.
  </action>
  <verify>
Run `npm run dev` at final chosen scale:
1. Player and tiles render at consistent scale
2. Pixels are crisp (no blur)
3. Map fills reasonable portion of viewport
4. Character is clearly visible and distinguishable
  </verify>
  <done>Scale factor optimized for Pokemon sprites, pixel-perfect rendering confirmed</done>
</task>

</tasks>

<verification>
After all tasks:
1. Player renders as 16x32 sprite (visibly taller than tiles)
2. Walk animation cycles through 4 frames
3. Player feet align with ground tiles
4. Sprite is crisp at chosen scale
5. No visual glitches (clipping, floating, wrong alignment)
</verification>

<success_criteria>
- Player character renders at correct 16x32 size
- Animation frames cycle during movement (4 frames per direction)
- Position offset correct (feet on ground, head extends up)
- Pixel-perfect rendering (no blur, crisp edges)
- Scale factor chosen and documented
</success_criteria>

<output>
After completion, create `.planning/phases/09-change-game/09-03-SUMMARY.md`
</output>
