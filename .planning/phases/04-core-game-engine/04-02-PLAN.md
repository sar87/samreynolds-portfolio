---
phase: 04-core-game-engine
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/game/rendering/TileMap.ts
  - src/game/systems/Collision.ts
  - src/game/data/testMap.ts
autonomous: true

must_haves:
  truths:
    - "Tile map stores and retrieves tile data by coordinates"
    - "Collision system detects solid tiles blocking movement"
    - "Test map provides a playable area with walls"
  artifacts:
    - path: "src/game/rendering/TileMap.ts"
      provides: "Tile data structure with solid tile queries"
      exports: ["TileMap", "TileType"]
      min_lines: 60
    - path: "src/game/systems/Collision.ts"
      provides: "AABB collision detection against tiles"
      exports: ["Collision"]
      min_lines: 40
    - path: "src/game/data/testMap.ts"
      provides: "Simple test map for Phase 4"
      exports: ["testMapData"]
      min_lines: 20
  key_links:
    - from: "src/game/systems/Collision.ts"
      to: "src/game/rendering/TileMap.ts"
      via: "isSolid queries"
      pattern: "tileMap\\.isSolid"
    - from: "src/game/rendering/TileMap.ts"
      to: "EngineConfig"
      via: "tile size constant"
      pattern: "EngineConfig\\.tileSize"
---

<objective>
Create the tile map data structure, collision detection system, and a simple test map for Phase 4 development.

Purpose: The tile map stores world data and provides spatial queries. The collision system prevents players from walking through solid tiles. The test map gives us something to move around in.

Output: TileMap and Collision classes plus test map data that together enable walkable/blocked areas.
</objective>

<execution_context>
@/home/sam/.claude/get-shit-done/workflows/execute-plan.md
@/home/sam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-game-engine/04-CONTEXT.md
@.planning/phases/04-core-game-engine/04-RESEARCH.md
@src/config/engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TileMap data structure</name>
  <files>src/game/rendering/TileMap.ts</files>
  <action>
Create a TileMap class that stores tile data and provides spatial queries.

Requirements:
- Store tiles as a flat array indexed by (y * width + x)
- Support multiple tile types (grass, wall, water, path)
- Provide getTile(col, row) returning tile type
- Provide isSolid(col, row) returning boolean
- Provide getWidth(), getHeight() in tiles
- Provide getPixelWidth(), getPixelHeight() at render scale
- Import EngineConfig for tile size

Tile types enum:
```typescript
export enum TileType {
  EMPTY = 0,
  GRASS = 1,
  WALL = 2,
  WATER = 3,
  PATH = 4,
}

// Solid tiles that block movement
const SOLID_TILES = new Set([TileType.WALL, TileType.WATER]);
```

TileMap class:
```typescript
export class TileMap {
  constructor(
    private readonly width: number,
    private readonly height: number,
    private readonly tiles: TileType[]
  ) {}

  getTile(col: number, row: number): TileType { ... }
  isSolid(col: number, row: number): boolean { ... }
  getWidth(): number { ... }
  getHeight(): number { ... }
  getPixelWidth(): number { ... }  // width * tileSize * scale
  getPixelHeight(): number { ... } // height * tileSize * scale
}
```

Bounds checking: Return EMPTY for out-of-bounds coordinates, treat as passable (allows spawning at edges).
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
TileMap class stores tile data, provides isSolid/getTile queries, returns dimensions in tiles and pixels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Collision system</name>
  <files>src/game/systems/Collision.ts</files>
  <action>
Create a Collision class that checks AABB collision against solid tiles.

Requirements from RESEARCH.md:
- Check if rectangular area overlaps any solid tiles
- Process X and Y movement SEPARATELY (prevents sticky walls)
- Work in pixel coordinates (at render scale)
- Return new position after collision resolution

Implementation:
```typescript
export class Collision {
  constructor(private tileMap: TileMap) {}

  // Check if bounding box overlaps solid tiles
  isCollidingWithTiles(x: number, y: number, width: number, height: number): boolean {
    const tileSize = EngineConfig.renderedTileSize; // 64px at 2x scale

    // Get tile coordinates for all corners
    const left = Math.floor(x / tileSize);
    const right = Math.floor((x + width - 1) / tileSize);
    const top = Math.floor(y / tileSize);
    const bottom = Math.floor((y + height - 1) / tileSize);

    // Check all overlapped tiles
    for (let row = top; row <= bottom; row++) {
      for (let col = left; col <= right; col++) {
        if (this.tileMap.isSolid(col, row)) {
          return true;
        }
      }
    }
    return false;
  }

  // Move with collision, processing X and Y separately (CRITICAL)
  moveWithCollision(
    currentX: number,
    currentY: number,
    deltaX: number,
    deltaY: number,
    width: number,
    height: number
  ): { x: number; y: number } {
    let newX = currentX;
    let newY = currentY;

    // Test X axis separately
    if (!this.isCollidingWithTiles(currentX + deltaX, currentY, width, height)) {
      newX += deltaX;
    }

    // Test Y axis separately (using newX, not currentX)
    if (!this.isCollidingWithTiles(newX, currentY + deltaY, width, height)) {
      newY += deltaY;
    }

    return { x: newX, y: newY };
  }
}
```

Context decision: Hard stop on collision (no sliding along walls) means we simply don't apply the movement if blocked. The separate X/Y processing handles corner cases.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
Collision class checks AABB against solid tiles, processes X/Y separately, returns resolved position.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create test map data</name>
  <files>src/game/data/testMap.ts</files>
  <action>
Create a simple test map for Phase 4 development and testing.

Requirements:
- Small but large enough to test camera (20x15 tiles = ~15x12 visible at once)
- Border walls around edges
- Some internal walls/obstacles
- Water feature (River Cam placeholder)
- Open grass area for movement
- At least one path

Map layout (20x15):
```
WWWWWWWWWWWWWWWWWWWW  (W = wall)
W..................W
W..................W
W...PPPP...........W
W...P..P...WWWW....W
W...P..P...W..W....W
W...PPPP...W..W....W
W..........WWWW....W
W..................W
W......~~~~........W  (~ = water)
W......~~~~........W
W......~~~~........W
W..................W
W..................W
WWWWWWWWWWWWWWWWWWWW
```

Export as:
```typescript
import { TileType } from '../rendering/TileMap';

export const testMapData = {
  width: 20,
  height: 15,
  tiles: [ ... ] as TileType[],
  playerSpawn: { x: 3, y: 3 }, // In tile coordinates
};
```

Use TileType enum values: GRASS=1, WALL=2, WATER=3, PATH=4
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
Verify map dimensions: tiles array length === width * height (300)
  </verify>
  <done>
Test map with 20x15 tiles, border walls, internal obstacles, water, and player spawn point.
  </done>
</task>

</tasks>

<verification>
All modules compile and work together:
```bash
npx tsc --noEmit
```

Files exist with expected exports:
- src/game/rendering/TileMap.ts exports TileMap class and TileType enum
- src/game/systems/Collision.ts exports Collision class
- src/game/data/testMap.ts exports testMapData object
</verification>

<success_criteria>
1. TileMap stores tiles and answers isSolid queries correctly
2. Collision processes X/Y separately (no sticky walls)
3. Test map has border walls, obstacles, and water
4. All dimensions use EngineConfig for consistency
5. All modules compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-game-engine/04-02-SUMMARY.md`
</output>
